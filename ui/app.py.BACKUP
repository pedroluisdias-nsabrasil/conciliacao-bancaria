"""
Sistema de ConciliaÃ§Ã£o BancÃ¡ria - Interface Web.

AplicaÃ§Ã£o principal Streamlit que serve como pÃ¡gina inicial
do sistema de conciliaÃ§Ã£o bancÃ¡ria.

Author: Pedro Luis (pedroluisdias@br-nsa.com)
Created: 04/11/2025
Version: 1.0.0
"""
# Configurar PYTHONPATH
import sys
from pathlib import Path

# Detectar se estÃ¡ em pages/ ou em ui/
arquivo_atual = Path(__file__).resolve()
if 'pages' in str(arquivo_atual.parent):
    # Estamos em ui/pages/ - subir 2 nÃ­veis
    raiz = arquivo_atual.parent.parent.parent
else:
    # Estamos em ui/ - subir 1 nÃ­vel
    raiz = arquivo_atual.parent.parent

# Adicionar raiz e src/ ao path
if str(raiz) not in sys.path:
    sys.path.insert(0, str(raiz))
if str(raiz / 'src') not in sys.path:
    sys.path.insert(0, str(raiz / 'src'))

import streamlit as st

# ============================================================================
# CONFIGURAÃ‡ÃƒO DA PÃGINA
# ============================================================================

st.set_page_config(
    page_title="ConciliaÃ§Ã£o BancÃ¡ria",
    page_icon="ðŸ’°",
    layout="wide",
    initial_sidebar_state="expanded",
    menu_items={
        'Get Help': 'https://github.com/seu-usuario/conciliacao-bancaria',
        'Report a bug': 'https://github.com/seu-usuario/conciliacao-bancaria/issues',
        'About': '''
        # Sistema de ConciliaÃ§Ã£o BancÃ¡ria v1.0
        
        Sistema automatizado para conciliar extratos bancÃ¡rios
        com comprovantes de pagamento.
        
        **Desenvolvido por:** Pedro Luis
        '''
    }
)


# ============================================================================
# INICIALIZAR SESSION STATE
# ============================================================================

def init_session_state():
    """Inicializa variÃ¡veis de sessÃ£o."""
    if 'lancamentos' not in st.session_state:
        st.session_state.lancamentos = None
    
    if 'comprovantes' not in st.session_state:
        st.session_state.comprovantes = None
    
    if 'matches' not in st.session_state:
        st.session_state.matches = None
    
    if 'stats' not in st.session_state:
        st.session_state.stats = None
    
    if 'motor_config' not in st.session_state:
        st.session_state.motor_config = {
            'confianca_minima': 0.60,
            'confianca_auto_aprovar': 0.90,
            'tolerancia_dias': 3,
        }


# ============================================================================
# SIDEBAR
# ============================================================================

def render_sidebar():
    """Renderiza sidebar com navegaÃ§Ã£o e estatÃ­sticas."""
    with st.sidebar:
        st.image("https://via.placeholder.com/300x100/0066cc/ffffff?text=Sistema+de+ConciliaÃ§Ã£o", 
                 use_container_width=True)
        
        st.title("ðŸ¦ ConciliaÃ§Ã£o BancÃ¡ria")
        st.markdown("---")
        
        # Navegação
        st.subheader("📍 Navegação")
        st.page_link("app.py", label="🏠 Home", icon="🏠")
        st.page_link("pages/1_📤_Upload.py", label="Upload de Arquivos", icon="📤")
        st.page_link("pages/2_🔄_Conciliar.py", label="Executar Conciliação", icon="🔄")
        st.page_link("pages/3_📊_Resultados.py", label="Ver Resultados", icon="📊")
        st.page_link("pages/5_📋_Regras.py", label="📋 Regras de Auto-Conciliação")

        st.markdown("---")        
        # EstatÃ­sticas rÃ¡pidas
        st.subheader("ðŸ“ˆ Status Atual")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.session_state.lancamentos:
                st.metric("LanÃ§amentos", len(st.session_state.lancamentos))
            else:
                st.metric("LanÃ§amentos", "0")
        
        with col2:
            if st.session_state.comprovantes:
                st.metric("Comprovantes", len(st.session_state.comprovantes))
            else:
                st.metric("Comprovantes", "0")
        
        if st.session_state.stats:
            st.metric(
                "Taxa de ConciliaÃ§Ã£o",
                f"{st.session_state.stats['taxa_conciliacao']:.1%}",
                delta=None
            )
            st.metric(
                "ConfianÃ§a MÃ©dia",
                f"{st.session_state.stats['confianca_media']:.1%}",
                delta=None
            )
        
        st.markdown("---")
        
        # ConfiguraÃ§Ãµes rÃ¡pidas
        with st.expander("âš™ï¸ ConfiguraÃ§Ãµes"):
            st.session_state.motor_config['confianca_minima'] = st.slider(
                "ConfianÃ§a MÃ­nima",
                min_value=0.0,
                max_value=1.0,
                value=st.session_state.motor_config['confianca_minima'],
                step=0.05,
                help="ConfianÃ§a mÃ­nima para aceitar um match"
            )
            
            st.session_state.motor_config['confianca_auto_aprovar'] = st.slider(
                "Auto-aprovar Acima de",
                min_value=0.0,
                max_value=1.0,
                value=st.session_state.motor_config['confianca_auto_aprovar'],
                step=0.05,
                help="ConfianÃ§a mÃ­nima para auto-aprovar match"
            )
            
            st.session_state.motor_config['tolerancia_dias'] = st.number_input(
                "TolerÃ¢ncia de Dias",
                min_value=0,
                max_value=30,
                value=st.session_state.motor_config['tolerancia_dias'],
                help="DiferenÃ§a mÃ¡xima de dias entre lanÃ§amento e comprovante"
            )
        
        st.markdown("---")
        st.caption("v1.0.0 | Pedro Luis")


# ============================================================================
# PÃGINA PRINCIPAL (HOME)
# ============================================================================

def main():
    """PÃ¡gina principal da aplicaÃ§Ã£o."""
    
    # Inicializar session state
    init_session_state()
    
    # Renderizar sidebar
    render_sidebar()
    
    # ConteÃºdo principal
    st.title("ðŸ¦ Sistema de ConciliaÃ§Ã£o BancÃ¡ria")
    st.markdown("### Automatize a conciliaÃ§Ã£o de extratos bancÃ¡rios com comprovantes")
    
    st.markdown("---")
    
    # Cards informativos
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        ### ðŸ“¤ 1. Upload
        
        FaÃ§a upload do seu extrato bancÃ¡rio (CSV) e dos 
        comprovantes de pagamento (PDF).
        
        [Ir para Upload â†’](./pages/1_ðŸ“¤_Upload.py)
        """)
    
    with col2:
        st.markdown("""
        ### ðŸ”„ 2. Conciliar
        
        Execute a conciliaÃ§Ã£o automÃ¡tica com configuraÃ§Ãµes
        personalizadas.
        
        [Ir para ConciliaÃ§Ã£o â†’](./pages/2_ðŸ”„_Conciliar.py)
        """)
    
    with col3:
        st.markdown("""
        ### ðŸ“Š 3. Resultados
        
        Visualize os matches encontrados, estatÃ­sticas
        e exporte relatÃ³rios.
        
        [Ver Resultados â†’](./pages/3_ðŸ“Š_Resultados.py)
        """)
    
    st.markdown("---")
    
    # InformaÃ§Ãµes sobre o sistema
    st.subheader("â„¹ï¸ Sobre o Sistema")
    
    with st.expander("Como funciona?", expanded=False):
        st.markdown("""
        O sistema realiza a conciliaÃ§Ã£o em 3 etapas:
        
        1. **Leitura de Dados**
           - Extrato bancÃ¡rio (CSV)
           - Comprovantes de pagamento (PDF com OCR)
        
        2. **Matching Inteligente**
           - Compara valores e datas
           - Calcula confianÃ§a do match (0% a 100%)
           - Aplica mÃºltiplas estratÃ©gias
        
        3. **ClassificaÃ§Ã£o**
           - âœ… Auto-aprovados (confianÃ§a â‰¥ 90%)
           - âš ï¸ Revisar (confianÃ§a 60-90%)
           - âŒ Sem match (confianÃ§a < 60%)
        """)
    
    with st.expander("MÃ©tricas de Sucesso", expanded=False):
        st.markdown("""
        ### ðŸŽ¯ Metas do Sistema
        
        - **Taxa de ConciliaÃ§Ã£o:** 60-70% automÃ¡tica
        - **PrecisÃ£o:** >95% de matches corretos
        - **Performance:** <5 segundos para 100 lanÃ§amentos
        - **ReduÃ§Ã£o de Tempo:** 70% menos trabalho manual
        """)
    
    with st.expander("Formatos Suportados", expanded=False):
        st.markdown("""
        ### ðŸ“„ Arquivos Aceitos
        
        **Extratos BancÃ¡rios:**
        - CSV (ItaÃº, Bradesco, Santander, Banco do Brasil, genÃ©rico)
        - Excel (XLSX)
        - PDF com texto extraÃ­vel
        
        **Comprovantes:**
        - PDF com texto
        - PDF escaneado (com OCR)
        - Imagens PNG/JPG (com OCR)
        """)
    
    # EstatÃ­sticas do projeto
    st.markdown("---")
    st.subheader("ðŸ“Š EstatÃ­sticas do Projeto")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("Linhas de CÃ³digo", "14.228")
    
    with col2:
        st.metric("Testes Automatizados", "91")
    
    with col3:
        st.metric("Taxa de Sucesso", "100%")
    
    with col4:
        st.metric("Progresso MVP", "100%")
    
    st.markdown("---")
    
    # InÃ­cio rÃ¡pido
    st.subheader("ðŸš€ InÃ­cio RÃ¡pido")
    
    st.markdown("""
    1. Clique em **ðŸ“¤ Upload de Arquivos** no menu lateral
    2. FaÃ§a upload do seu extrato bancÃ¡rio (CSV)
    3. FaÃ§a upload dos comprovantes (PDF)
    4. Clique em **ðŸ”„ Executar ConciliaÃ§Ã£o**
    5. Veja os resultados em **ðŸ“Š Ver Resultados**
    """)
    
    # BotÃ£o de aÃ§Ã£o
    st.markdown("")
    if st.button("ðŸš€ ComeÃ§ar Agora", type="primary", use_container_width=True):
        st.switch_page("pages/1_ðŸ“¤_Upload.py")
    
    # Footer
    st.markdown("---")
    st.caption("""
    Sistema de ConciliaÃ§Ã£o BancÃ¡ria v1.0.0 | 
    Desenvolvido por Pedro Luis | 
    MVP 100% Completo
    """)


if __name__ == "__main__":
    main()

